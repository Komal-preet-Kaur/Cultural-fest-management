<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Events - Cards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/home">Cultural Festival</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/home">Home</a>
            <a class="nav-link" href="/events/my-participations">My Events</a>
        </div>
    </div>
 </nav>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">All Events</h2>
        <a class="btn btn-primary" id="addEventBtn" style="display:none" href="/events/new"><i class="fas fa-plus me-2"></i>Add Event</a>
    </div>

    <div class="row" id="cardsContainer">
        <div class="col-12 text-center" th:if="${#lists.isEmpty(events)}">
            <p class="text-muted">No events yet.</p>
        </div>
        <div class="col-md-6 col-lg-4 mb-4" th:each="e : ${events}">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-primary" th:text="${e.name}"></h5>
                    <p class="card-text">
                        <i class="fas fa-tag me-2"></i><strong>Category:</strong> <span th:text="${e.category}"></span><br>
                        <i class="fas fa-calendar me-2"></i><strong>Date:</strong> <span th:text="${e.scheduledAt}"></span><br>
                        <i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> <span th:text="${e.location}"></span><br>
                        <i class="fas fa-users me-2"></i><strong>Capacity:</strong> <span th:text="${e.capacity}"></span>
                    </p>
                </div>
                <div class="card-footer bg-transparent d-flex gap-2">
                    <button class="btn btn-outline-success btn-sm" th:attr="data-id=${e.id}" onclick="participate(this)">
                        <i class="fas fa-user-plus me-1"></i>Participate
                    </button>
                    <button class="btn btn-outline-primary btn-sm" th:attr="data-id=${e.id}" onclick="viewEvent(this.getAttribute('data-id'))">
                        <i class="fas fa-eye me-1"></i>View Details
                    </button>
                    <button class="btn btn-outline-danger btn-sm admin-only" th:attr="data-id=${e.id}" onclick="deleteEvent(this)" style="display: none;">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple Add Event Modal (prompt-based for now) -->
<script>
    function getRoleFromToken() {
        try {
            const t = localStorage.getItem('token');
            if (!t) return null;
            const payload = JSON.parse(atob(t.split('.')[1]));
            return payload.role || null;
        } catch (e) { return null; }
    }

    async function participate(btn) {
        const eventId = btn.getAttribute('data-id');
        const token = localStorage.getItem('token');
        
        if (!token) {
            alert('Please login first to participate in events.');
            window.location.href = '/auth/login';
            return;
        }

        // Disable button to prevent multiple clicks
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Joining...';

        try {
            const response = await fetch(`/events/api/${eventId}/participate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok) {
                // Success - update button to show joined state
                btn.innerHTML = '<i class="fas fa-check me-1"></i>Joined!';
                btn.className = 'btn btn-success btn-sm';
                btn.disabled = true;
                
                // Show success message
                showNotification('Successfully joined "' + result.eventName + '"!', 'success');
            } else {
                // Error - restore button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-plus me-1"></i>Participate';
                
                if (response.status === 409) {
                    // Already participating or event full
                    if (result.error.includes('Already participating')) {
                        btn.innerHTML = '<i class="fas fa-check me-1"></i>Already Joined';
                        btn.className = 'btn btn-success btn-sm';
                        btn.disabled = true;
                    } else if (result.error.includes('full')) {
                        btn.innerHTML = '<i class="fas fa-times me-1"></i>Event Full';
                        btn.className = 'btn btn-danger btn-sm';
                        btn.disabled = true;
                    }
                }
                
                showNotification(result.error || 'Failed to join event', 'error');
            }
        } catch (error) {
            // Network error - restore button
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-user-plus me-1"></i>Participate';
            showNotification('Network error. Please try again.', 'error');
        }
    }

    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    // View event details
    function viewEvent(eventId) {
        window.location.href = `/events/${eventId}`;
    }

    // Delete event
    async function deleteEvent(btn) {
        const eventId = btn.getAttribute('data-id');
        
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
            return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            alert('Please login first.');
            window.location.href = '/auth/login';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';

        try {
            const response = await fetch(`/events/api/${eventId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showNotification('Event deleted successfully!', 'success');
                // Remove the card from the page
                btn.closest('.col-md-6').remove();
            } else {
                const result = await response.json();
                showNotification(result.error || 'Failed to delete event', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
            }
        } catch (error) {
            showNotification('Network error. Please try again.', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash me-1"></i>Delete';
        }
    }

    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const role = getRoleFromToken();
        if (role === 'ADMIN') {
            document.getElementById('addEventBtn').style.display = 'inline-block';
            // Show delete buttons for admin
            document.querySelectorAll('.admin-only').forEach(btn => {
                btn.style.display = 'inline-block';
            });
        }
    });
</script>

</body>
</html>


